// Copyright (c) 2013 Pieroxy <pieroxy@pieroxy.net>
// This work is free. You can redistribute it and/or modify it
// under the terms of the WTFPL, Version 2
// For more information see LICENSE.txt or http://www.wtfpl.net/
//
// For more information, the home page:
// http://pieroxy.net/blog/pages/lz-string/testing.html
//
// LZ-based compression algorithm, version 1.4.4
var l=String.fromCharCode,
    Z=Object.prototype.hasOwnProperty,
    r=Math.pow,
    Y=32768,
    X=(a,b)=>a.charCodeAt(b);

module.exports={compress:t=>{if(null==t)return"";var c,p={},u={},g="",m=2,q=3,e=2,f=[],a=0,b=0,h;for(h=0;h<t.length;h+=1){var k=t.charAt(h);Z.call(p,k)||(p[k]=q++,u[k]=!0);var n=g+k;if(Z.call(p,n))g=n;else{if(Z.call(u,g)){if(256>X(g,0)){for(c=0;c<e;c++)a<<=1,15==b?(b=0,f.push(l(a)),a=0):b++;var d=X(g,0);for(c=0;8>c;c++)a=a<<1|d&1,15==b?(b=0,f.push(l(a)),a=0):b++,d>>=1}else{d=1;for(c=0;c<e;c++)a=a<<1|d,15==b?(b=0,f.push(l(a)),a=0):b++,d=0;d=X(g,0);for(c=0;16>c;c++)a=a<<1|d&1,15==b?(b=0,f.push(l(a)),a=0):b++,d>>=1}m--;0==m&&(m=r(2,e),e++);delete u[g]}else for(d=p[g],c=0;c<e;c++)a=a<<1|d&1,15==b?(b=0,f.push(l(a)),a=0):b++,d>>=1;m--;0==m&&(m=r(2,e),e++);p[n]=q++;g=String(k)}}if(""!==g){if(Z.call(u,g)){if(256>X(g,0)){for(c=0;c<e;c++)a<<=1,15==b?(b=0,f.push(l(a)),a=0):b++;d=X(g,0);for(c=0;8>c;c++)a=a<<1|d&1,15==b?(b=0,f.push(l(a)),a=0):b++,d>>=1}else{d=1;for(c=0;c<e;c++)a=a<<1|d,15==b?(b=0,f.push(l(a)),a=0):b++,d=0;d=X(g,0);for(c=0;16>c;c++)a=a<<1|d&1,15==b?(b=0,f.push(l(a)),a=0):b++,d>>=1}m--;0==m&&(m=r(2,e),e++);delete u[g]}else for(d=p[g],c=0;c<e;c++)a=a<<1|d&1,15==b?(b=0,f.push(l(a)),a=0):b++,d>>=1;m--;0==m&&(r(2,e),e++)}d=2;for(c=0;c<e;c++)a=a<<1|d&1,15==b?(b=0,f.push(l(a)),a=0):b++,d>>=1;for(;;)if(a<<=1,15==b){f.push(l(a));break}else b++;return f.join("")},decompress:t=>{var c=[],p=4,u=4,g=3,m=[],q,e,f=X(t,0),a=Y,b=1;for(q=0;3>q;q+=1)c[q]=q;var h=0;var k=r(2,2);for(e=1;e!=k;){var n=f&a;a>>=1;0==a&&(a=Y,f=X(t,b++));h|=(0<n?1:0)*e;e<<=1}switch(h){case 0:h=0;k=r(2,8);for(e=1;e!=k;)n=f&a,a>>=1,0==a&&(a=Y,f=X(t,b++)),h|=(0<n?1:0)*e,e<<=1;var d=l(h);break;case 1:h=0;k=r(2,16);for(e=1;e!=k;)n=f&a,a>>=1,0==a&&(a=Y,f=X(t,b++)),h|=(0<n?1:0)*e,e<<=1;d=l(h);break;case 2:return""}q=c[3]=d;for(m.push(d);;){if(b>t.length)return"";h=0;k=r(2,g);for(e=1;e!=k;)n=f&a,a>>=1,0==a&&(a=Y,f=X(t,b++)),h|=(0<n?1:0)*e,e<<=1;switch(d=h){case 0:h=0;k=r(2,8);for(e=1;e!=k;)n=f&a,a>>=1,0==a&&(a=Y,f=X(t,b++)),h|=(0<n?1:0)*e,e<<=1;c[u++]=l(h);d=u-1;p--;break;case 1:h=0;k=r(2,16);for(e=1;e!=k;)n=f&a,a>>=1,0==a&&(a=Y,f=X(t,b++)),h|=(0<n?1:0)*e,e<<=1;c[u++]=l(h);d=u-1;p--;break;case 2:return m.join("")}0==p&&(p=r(2,g),g++);if(c[d])d=c[d];else if(d===u)d=q+q.charAt(0);else return null;m.push(d);c[u++]=q+d.charAt(0);p--;q=d;0==p&&(p=r(2,g),g++)}}};

/*
var 4 (10x)
return 6 (7x)
push 5 (15)
&& 3 (12)
?1:0 4 (7)
):b++ 5 (12)
0==a&&(a=Y,f=X(t,b++)) 22 (7)
,15==b?(b=0,f.push(l(a)),a=0):b++ 33 (11)
else 4 (8)
*/
